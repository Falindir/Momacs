<div>
  <p id="mode"><b>Mode </b>: nothing</p>
  
  <canvas id="canvas" width="800" height="600" style="cursor:crosshair;"></canvas>
  
</div>

<script>

$('#canvas').css('background-color', 'rgba(127, 140, 141, 0.2)');

var canvas = document.getElementById("canvas");
canvas.started = false;
canvas.width = 800;
canvas.height = 600;
canvas.state = "nothing";
canvas.scaleFactor = 1.05;
canvas.pointSize = 3;
canvas.lastX=canvas.width/2;
canvas.lastY=canvas.height/2;
canvas.currentScale = 1;
canvas.dragStart = null;
canvas.imagePath = "";

canvas.idPoint = 0;

canvas.indexPoint2D = 0;
canvas.arrayPoint2D = [];

canvas.indexSegment2D = 0;
canvas.arraySegment2D = [];
canvas.firstSegment = true;

canvas.curve = null;

canvas.draggedPoint = null;

//canvas.arrayPartionPoint2D = [];
//canvas.arrayPartitionSegment2D = [];
//canvas.arrayPartitionSegment2D = [];

var ctx = null;
var ima1 = null;

window.onload = function(){ 
          
ctx = canvas.getContext('2d');
trackTransforms(ctx);
canvas.curve = new Curve2D(0);

//===========================================================================

canvas.addEventListener('click',function(evt)
{
  if(canvas.started) {
        this.lastX = evt.offsetX || (evt.pageX - canvas.offsetLeft);
        this.lastY = evt.offsetY || (evt.pageY - canvas.offsetTop);
        var pt = ctx.transformedPoint(this.lastX,this.lastY);
        if(canvas.state == "drawPoint") {
            this.drawCoordinates(pt.x,pt.y);
            var point = new Point2D(this.idPoint, pt.x, pt.y);
            this.arrayPoint2D.push(point);
            this.indexPoint2D++;
            this.idPoint++;
        } else if(canvas.state == "drawSegment") {
            this.drawCoordinates(pt.x,pt.y);
            var p = new Point2D(this.idPoint, pt.x, pt.y);
            this.idPoint++;
            if(this.firstSegment) {
               if(this.indexSegment2D == 0) {
                  var s = new Segment2D(this.indexSegment2D, p, null);
                  this.arraySegment2D.push(s);
                  this.indexSegment2D++;
               } else {
                  this.arraySegment2D[this.indexSegment2D - 1].p2 = p;
                  this.drawLine(this.arraySegment2D[this.indexSegment2D - 1].p1, p);
                  this.firstSegment = false;
               }
            } else {
              var lastp = this.arraySegment2D[this.indexSegment2D - 1].p2;
              var s = new Segment2D(this.indexSegment2D, lastp, p);
              this.drawLine(lastp, p);
              this.arraySegment2D.push(s);
              this.indexSegment2D++;
            }
        } else if(canvas.state == "drawCurve") {
            var p = new Point2D(this.idPoint, pt.x, pt.y);
            this.idPoint++;
            this.curve.points.push(p);
            this.curve.size++;
            this.redraw();
        } else if(canvas.state == "deletePoint") {
            var point = new Point2D(0, pt.x, pt.y);
            var indexToDelete = null;
            for (var i = 0; i < this.indexPoint2D; i++) {
                var d = this.distance(point, this.arrayPoint2D[i]);
                if(d <= this.pointSize) {
                   indexToDelete = i;
                   break;
                }
            }
            if(indexToDelete != null) { //we found à point to delete
                var newPoints = [];
                for (var i = 0; i < this.indexPoint2D; i++) {
                  if(i != indexToDelete){
                     newPoints.push(this.arrayPoint2D[i]);
                  }
                }
                this.arrayPoint2D = newPoints;
                this.indexPoint2D--;
            }
            this.redraw();
        } else if(canvas.state == "deletePointSegment") {
            var point = new Point2D(0, pt.x, pt.y);
            var indexToDelete = null;
            var pToDelete = null;
            for (var i = 0; i < this.indexSegment2D; i++) {
                var d1 = this.distance(point, this.arraySegment2D[i].p1);
                var d2 = this.distance(point, this.arraySegment2D[i].p2);
                if(d1 <= this.pointSize) {
                   indexToDelete = i;
                   pToDelete = 1;
                   break;
                } else if(d2 <= this.pointSize) {
                   indexToDelete = i;
                   pToDelete = 2;
                   break;
                }
            }
            if(indexToDelete != null) { //we found à point to delete
              
            
               var newSegments = [];
               if(indexToDelete == 0 && pToDelete == 1) { //cas particulier de 1er
                  for (var i = 1; i < this.indexSegment2D; i++) {
                    newSegments.push(this.arraySegment2D[i]);
                  }
                  this.arraySegment2D = newSegments;
                  this.indexSegment2D--;
               } else if(indexToDelete == this.indexSegment2D - 1 && pToDelete == 2) { //cas particulier du dernier
                    for (var i = 0; i < this.indexSegment2D - 1; i++) {
                        newSegments.push(this.arraySegment2D[i]);
                    }
                  this.arraySegment2D = newSegments;
                  this.indexSegment2D--;
               } else { 
                  for (var i = 0; i < this.indexSegment2D; i++) {
                    if(indexToDelete == i) {
                        //normalement c toujour p2
                         var old = this.arraySegment2D[i];
                         var old2 = this.arraySegment2D[i+1];
                         var p1 = new Point2D(old.p1.id, old.p1.x, old.p1.y);
                         var p2 = new Point2D(old2.p2.id, old2.p2.x, old2.p2.y);
                         var newss = new Segment2D(old.id, p1, p2);
                         newSegments.push(newss);
                    } else {
                       if(indexToDelete+1 == i) {
                          //nothing to do                         
                       } else {
                          newSegments.push(this.arraySegment2D[i]);
                       }
                    }
                  }
                  this.arraySegment2D = newSegments;
                  this.indexSegment2D--;
               }
            }
            
            if(this.indexSegment2D == 0) {
              canvas.firstSegment = true;
            }
            
            this.redraw();
        } else if(canvas.state == "deletePointCurve") {
            var point = new Point2D(0, pt.x, pt.y);
            var indexToDelete = null;
            for (var i = 0; i < this.curve.size; i++) {
                var d = this.distance(point, this.curve.points[i]);
                if(d <= this.pointSize) {
                   indexToDelete = i;
                   break;
                }
            }
            
             if(indexToDelete != null) {
                 
                  var newPoints = [];
          
                  for (var i = 0; i < this.curve.size; i++) {
                      if(i != indexToDelete){
                          newPoints.push(this.curve.points[i]);
                      }
                  }
                  this.curve.points = newPoints;
                  this.curve.size--;
                
            }
            
            
          this.redraw();
        }
  }
},false);

//===========================================================================

canvas.addEventListener('mousedown',function(evt)
{
  if(canvas.started) {
    document.body.style.mozUserSelect = document.body.style.webkitUserSelect = document.body.style.userSelect = 'none';
    this.lastX = evt.offsetX || (evt.pageX - canvas.offsetLeft);
    this.lastY = evt.offsetY || (evt.pageY - canvas.offsetTop);
    var pt = ctx.transformedPoint(this.lastX,this.lastY);
    if(canvas.state == "move") {
        this.dragStart = pt;
    }
    
    if(this.state == "movePoint") {
        var point = new Point2D(0, pt.x, pt.y);
        for (var i = 0; i < this.indexPoint2D; i++) {
            var d = this.distance(point, this.arrayPoint2D[i]);
            if(d <= this.pointSize) {
                 this.draggedPoint = this.arrayPoint2D[i];
                 break;
            }
        }
    }
    
    if(this.state == "movePointSegment") {
      var point = new Point2D(0, pt.x, pt.y);
      for (var i = 0; i < this.indexSegment2D; i++) {
                var d1 = this.distance(point, this.arraySegment2D[i].p1);
                var d2 = this.distance(point, this.arraySegment2D[i].p2);
                if(d1 <= this.pointSize) {
                   this.draggedPoint = this.arraySegment2D[i].p1;
                   break;
                } else if(d2 <= this.pointSize) {
                   this.draggedPoint = this.arraySegment2D[i].p2;
                   break;
                }
      }
    }
    
    if(this.state == "movePointCurve") {
        var point = new Point2D(0, pt.x, pt.y);
        for (var i = 0; i < this.curve.size; i++) {
               var d = this.distance(point, this.curve.points[i]);
               if(d <= this.pointSize) {
                 this.draggedPoint = this.curve.points[i];
                 break;
              }
          }
    }
    
  }
},false);

//===========================================================================

canvas.addEventListener('mouseup',function(evt)
{
  if(this.started) {
    if(this.state == "move") {
        this.dragStart = null;
    }
    
    if(this.state == "movePoint" || this.state == "movePointSegment" || this.state == "movePointCurve") {
        this.draggedPoint = null;
    }
  }
},false);

//===========================================================================

canvas.addEventListener('mouseleave',function(evt)
{
  if(this.started) {
    if(this.state == "move") {
        this.dragStart = null;
    }
    
    if(this.state == "movePoint" || this.state == "movePointSegment" || this.state == "movePointCurve") {
        this.draggedPoint = null;
    }
  }
},false);

//===========================================================================

canvas.addEventListener('mousemove',function(evt){
  
    if(canvas.started) {
        this.lastX = evt.offsetX || (evt.pageX - canvas.offsetLeft);
        this.lastY = evt.offsetY || (evt.pageY - canvas.offsetTop);
        var pt = ctx.transformedPoint(this.lastX,this.lastY);
        if(canvas.state == "move") {
              if (this.dragStart){
                
                ctx.translate(pt.x-this.dragStart.x,pt.y-this.dragStart.y);
                this.redraw();
              }
        }
        
        if(this.state == "movePoint" || this.state == "movePointSegment"|| this.state == "movePointCurve") {
           if(this.draggedPoint) {
              this.draggedPoint.x = pt.x;
              this.draggedPoint.y = pt.y;
              this.redraw();
           }
        }
        
        
    }
},false);

//===========================================================================

canvas.distance = function (p1, p2) {
  return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
}

//===========================================================================

canvas.drawCoordinates = function (x,y) {
    ctx.fillStyle = momacs_config.color_point; // Red color
    ctx.beginPath(); //Start path
    ctx.arc(x, y, this.pointSize, 0, Math.PI * 2, true); // Draw a point using the arc function of the canvas with a point structure.
    ctx.fill(); // Close the path and fill.
}

//===========================================================================

canvas.drawLine = function (p1, p2) {
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.strokeStyle = momacs_config.color_segment;
    ctx.lineWidth = 1.5;
    ctx.stroke();
    ctx.fill();
}

canvas.drawBezier = function (points) {
   var f = 0;
   var t = 1;
   
   if(points.length == 0) {
     return;
   }
   var pts = [];
   
   this.drawCoordinates(points[0].x,points[0].y);
   
   var j = 0;
   for (var i = 0; i < points.length; i++) {
     pts[j] = points[i].x;
     pts[j+1] = points[i].y;
     j += 2;
     this.drawCoordinates(points[i].x,points[i].y);
   }

  ctx.beginPath();
  ctx.moveTo(pts[0], pts[1]);
  
	var res = ctx.curve(pts, 0.5, 20, true);
	this.curve.allpts = res;
	ctx.lineWidth = 1.5;
	ctx.strokeStyle = momacs_config.color_curve;
	ctx.stroke();
}

//===========================================================================

canvas.gradient = function (a, b) {
    return (b.y-a.y)/(b.x-a.x);
}

//===========================================================================

canvas.zoom = function(clicks){
    if(canvas.started ) {
        var pt = ctx.transformedPoint(this.lastX,this.lastY);
        ctx.translate(pt.x,pt.y);
        var factor = Math.pow(this.scaleFactor,clicks);
        this.currentScale *= factor;
        ctx.scale(factor,factor);
        ctx.translate(-pt.x,-pt.y);
        this.redraw();
    }
}

//===========================================================================

var handleScroll = function(evt){
  if(canvas.started ) {
          var delta = evt.wheelDelta ? evt.wheelDelta/40 : evt.detail ? -evt.detail : 0;
          if (delta) canvas.zoom(delta);
          return evt.preventDefault() && false;
}
      };
    
//===========================================================================    
      
canvas.addEventListener('DOMMouseScroll',handleScroll,false);

//===========================================================================

canvas.addEventListener('mousewheel',handleScroll,false);

//===========================================================================

canvas.redraw = function (){

          // Clear the entire canvas
          var p1 = ctx.transformedPoint(0,0);
          var p2 = ctx.transformedPoint(this.width,this.height);
          ctx.clearRect(p1.x,p1.y,p2.x-p1.x,p2.y-p1.y);

          ctx.save();
          ctx.setTransform(1,0,0,1,0,0);
          ctx.clearRect(0,0,this.width,this.height);
          ctx.restore();

          ctx.drawImage(ima1,0,0);
          
          for (var i = 0; i < this.indexPoint2D; i++) {
              this.drawCoordinates(this.arrayPoint2D[i].x, this.arrayPoint2D[i].y); 
          }
          
          for (var i = 0; i < this.indexSegment2D; i++) {
              var p1 = this.arraySegment2D[i].p1;
              var p2 = this.arraySegment2D[i].p2;
            
              if(p2) {
                 this.drawCoordinates(p1.x, p1.y);
                 this.drawCoordinates(p2.x, p2.y);
                 this.drawLine(p1, p2);
              } else {
                this.drawCoordinates(p1.x, p1.y);
              }
          }
          
          this.drawBezier(this.curve.points);
}

//===========================================================================

canvas.changeMode = function(mode) {
   $("#buttonMoveImage").html('Start move image');
   $("#buttonDrawPoint").html('Start draw point');
   $("#buttonDrawSegment").html('Start draw segment');
   $("#buttonDrawCurve").html('Start draw curve');
   $("#buttonDeletePoint").html('Start delete point');
   $("#buttonDeletePointSegment").html('Start delete point and segment');
   $("#buttonDeletePointCurve").html('Start delete point and curve');
   $("#buttonMovePoint").html('Start move point');
   $("#buttonMovePointSegment").html('Start move point and segment');
   $("#buttonMovePointCurve").html('Start move point and curve');
   
   
   $("#mode").html("<b>Mode </b>: " + mode);
   
   if(mode == "move") {
     $("#buttonMoveImage").html('Stop move image');
   }
   
   if(mode == "drawPoint") {
      $("#buttonDrawPoint").html('Stop draw point');
   }
   
   if(mode == "drawSegment") {
     $("#buttonDrawSegment").html('Stop draw segment');
   }
   
   if(mode == "drawCurve") {
     $("#buttonDrawCurve").html('Stop draw curve');
   }
   
   if(mode == "deletePoint") {
      $("#buttonDeletePoint").html('Stop delete point');
   }
   
   if(mode == "deletePointSegment") {
     $("#buttonDeletePointSegment").html('Stop delete point and segment');
   }
   
    if(mode == "deletePointCurve") {
     $("#buttonDeletePointCurve").html('Stop delete point and curve');
   }
   
   if(mode == "movePoint") {
      $("#buttonMovePoint").html('Stop move point');
   }
   
   if(mode == "movePointSegment") {
     $("#buttonMovePointSegment").html('Stop move point and segment');
   }
   
    if(mode == "movePointCurve") {
     $("#buttonMovePointCurve").html('Stop move point and curve');
   }
}

//===========================================================================

$("#buttonMoveImage").click(function(e){
  if(canvas.started) {
    if(canvas.state == "move") {
      canvas.state = "nothing";
    } else {
      canvas.state = "move";
    }
    canvas.changeMode(canvas.state);
  }
});

//===========================================================================

$("#buttonDrawPoint").click(function(e){
    if(canvas.started) {
        if(canvas.state == "drawPoint") {
          canvas.state = "nothing";
        } else {
          canvas.state = "drawPoint";
        }
        
        canvas.changeMode(canvas.state);
    }
});

//===========================================================================

$("#buttonDrawSegment").click(function(e){
    if(canvas.started) {
        if(canvas.state == "drawSegment") {
          canvas.state = "nothing";
        } else {
          canvas.state = "drawSegment";
        }
        
        canvas.changeMode(canvas.state);
    }
});

//===========================================================================

$("#buttonDrawCurve").click(function(e){
    if(canvas.started) {
        if(canvas.state == "drawCurve") {
          canvas.state = "nothing";
        } else {
          canvas.state = "drawCurve";
        }
        canvas.changeMode(canvas.state);
    }
});


//===========================================================================

$("#buttonDeletePoint").click(function(e){ 
    if(canvas.started) {
      if(canvas.state == "deletePoint") {
          canvas.state = "nothing";
      } else {
         canvas.state = "deletePoint";
      }
      canvas.changeMode(canvas.state);
    }
});

//===========================================================================

$("#buttonDeletePointSegment").click(function(e){ 
    if(canvas.started) {
      if(canvas.state == "deletePointSegment") {
          canvas.state = "nothing";
      } else {
         canvas.state = "deletePointSegment";
      }
      canvas.changeMode(canvas.state);
    }
});

//===========================================================================

$("#buttonDeletePointCurve").click(function(e){ 
    if(canvas.started) {
      if(canvas.state == "deletePointCurve") {
          canvas.state = "nothing";
      } else {
         canvas.state = "deletePointCurve";
      }
      canvas.changeMode(canvas.state);
    }
});

//===========================================================================

$("#buttonMovePoint").click(function(e){ 
    if(canvas.started) {
      if(canvas.state == "movePoint") {
          canvas.state = "nothing";
      } else {
         canvas.state = "movePoint";
      }
      canvas.changeMode(canvas.state);
    }
});

//===========================================================================

$("#buttonMovePointSegment").click(function(e){ 
    if(canvas.started) {
      if(canvas.state == "movePointSegment") {
          canvas.state = "nothing";
      } else {
         canvas.state = "movePointSegment";
      }
      canvas.changeMode(canvas.state);
    }
});

//===========================================================================

$("#buttonMovePointCurve").click(function(e){ 
    if(canvas.started) {
      if(canvas.state == "movePointCurve") {
          canvas.state = "nothing";
      } else {
         canvas.state = "movePointCurve";
      }
      canvas.changeMode(canvas.state);
    }
});

//===========================================================================

$("#deleteLastElement").click(function(e){ 
  
    if(canvas.started) {
        if(canvas.state == "drawPoint") {
            if(canvas.indexPoint2D > 0) {
                canvas.indexPoint2D--;
                canvas.arrayPoint2D.pop();
            }
        }
        
        if(canvas.state == "drawSegment") {
            if(canvas.indexSegment2D > 0) {
                  if(canvas.indexSegment2D == 1) {
                    canvas.firstSegment = true;
                  }
                  canvas.indexSegment2D--;
                  canvas.arraySegment2D.pop();
            }
        }
        
        if(canvas.state == "drawCurve") {
            if(canvas.curve.size > 0) {
                canvas.curve.size--;
                canvas.curve.points.pop();
            }
        }
        
        canvas.redraw();
    }
});


$("#clearImage").click(function(e){
    if(canvas.started) {
        canvas.indexPoint2D = 0;
        canvas.arrayPoint2D = [];
        canvas.indexSegment2D = 0;
        canvas.arraySegment2D = [];
        canvas.firstSegment = true;
        canvas.curve.size = 0;
        canvas.curve.points = [];
        canvas.redraw();
    }
});

//===========================================================================

function trackTransforms(ctx){
      var svg = document.createElementNS("http://www.w3.org/2000/svg",'svg');
      var xform = svg.createSVGMatrix();
      ctx.getTransform = function(){ return xform; };

      var savedTransforms = [];
      var save = ctx.save;
      ctx.save = function(){
          savedTransforms.push(xform.translate(0,0));
          return save.call(ctx);
      };
    
      var restore = ctx.restore;
      ctx.restore = function(){
        xform = savedTransforms.pop();
        return restore.call(ctx);
		      };

      var scale = ctx.scale;
      ctx.scale = function(sx,sy){
        xform = xform.scaleNonUniform(sx,sy);
        return scale.call(ctx,sx,sy);
		      };
    
      var rotate = ctx.rotate;
      ctx.rotate = function(radians){
          xform = xform.rotate(radians*180/Math.PI);
          return rotate.call(ctx,radians);
      };
    
      var translate = ctx.translate;
      ctx.translate = function(dx,dy){
          xform = xform.translate(dx,dy);
          return translate.call(ctx,dx,dy);
      };
    
      var transform = ctx.transform;
      ctx.transform = function(a,b,c,d,e,f){
          var m2 = svg.createSVGMatrix();
          m2.a=a; m2.b=b; m2.c=c; m2.d=d; m2.e=e; m2.f=f;
          xform = xform.multiply(m2);
          return transform.call(ctx,a,b,c,d,e,f);
      };
    
      var setTransform = ctx.setTransform;
      ctx.setTransform = function(a,b,c,d,e,f){
          xform.a = a;
          xform.b = b;
          xform.c = c;
          xform.d = d;
          xform.e = e;
          xform.f = f;
          return setTransform.call(ctx,a,b,c,d,e,f);
      };
    
      var pt  = svg.createSVGPoint();
      ctx.transformedPoint = function(x,y){
          pt.x=x; pt.y=y;
          return pt.matrixTransform(xform.inverse());
      }
}

}

//===========================================================================

function drawImage(path) {
    var p1 = ctx.transformedPoint(0,0);
    var p2 = ctx.transformedPoint(canvas.width,canvas.height);
    ctx.clearRect(p1.x,p1.y,p2.x-p1.x,p2.y-p1.y);
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.restore();
    ima1 = new Image;
    ima1.onload = function () {
        ctx.drawImage(ima1,0,0);
    };
    ima1.src = path;
}

//===========================================================================

/**
 * Object Point2D  
 **/
var Point2D = function (id, x,y) {
  this.id = id;
  this.x = x;
  this.y = y;
}

//===========================================================================

/**
 * Object Segment2D
 **/
var Segment2D = function (id, p1, p2) {
  this.id = id;
  this.p1 = p1;
  this.p2 = p2;
}

//===========================================================================

var Curve2D = function (id) {
   this.id = id;
   this.size = 0;
   this.points = [];
   this.allpts = null;
}

//===========================================================================

var Partition = function (id, type) {
   this.id = id;
   this.type = type;
   this.size = 0;
   this.content = [];
}

//===========================================================================

$(document).keypress(function(e){
 
        var key = e.originalEvent.key;
      
        if(canvas.started && key == "p") {
          
          if(canvas.state == "drawPoint") {
              canvas.state = "nothing";
          } else {
              canvas.state = "drawPoint";
          }
          canvas.changeMode(canvas.state);
          
        } else if(canvas.started && key == "m") {
            if(canvas.state == "move") {
              canvas.state = "nothing";
            } else {
              canvas.state = "move";
            }
            canvas.changeMode(canvas.state);
        } else if (canvas.started && key == "s") {
            if(canvas.state == "drawSegment") {
              canvas.state = "nothing";
            } else {
              canvas.state = "drawSegment";
            }
            canvas.changeMode(canvas.state);
        } else if (canvas.started && key == "c") {
            if(canvas.state == "drawCurve") {
              canvas.state = "nothing";
            } else {
              canvas.state = "drawCurve";
            }
            canvas.changeMode(canvas.state);
        
        } else if (canvas.started && key == "r") {
              canvas.indexPoint2D = 0;
              canvas.arrayPoint2D = [];
              canvas.indexSegment2D = 0;
              canvas.arraySegment2D = [];
              canvas.firstSegment = true;
              canvas.curve.size = 0;
              canvas.curve.points = [];
              canvas.redraw();
        } else {
          
        }
});

  </script>